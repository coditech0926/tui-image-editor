!function t(e,n,i){function s(r,a){if(!n[r]){if(!e[r]){var c="function"==typeof require&&require;if(!a&&c)return c(r,!0);if(o)return o(r,!0);var h=new Error("Cannot find module '"+r+"'");throw h.code="MODULE_NOT_FOUND",h}var u=n[r]={exports:{}};e[r][0].call(u.exports,function(t){var n=e[r][1][t];return s(n?n:t)},u,u.exports,t,e,n,i)}return n[r].exports}for(var o="function"==typeof require&&require,r=0;r<i.length;r++)s(i[r]);return s}({1:[function(t,e,n){tui.util.defineNamespace("tui.component.ImageEditor",t("./src/js/imageEditor"),!0)},{"./src/js/imageEditor":14}],2:[function(t,e,n){"use strict";var i=t("../interface/component"),s=t("../extension/cropzone"),o=t("../consts"),r=t("../util"),a=10,c=Math.abs,h=r.clamp,u=o.keyCodes,l=tui.util.defineClass(i,{init:function(t){this.setParent(t),this._cropzone=null,this._startX=null,this._startY=null,this._withShiftKey=!1,this._listeners={keydown:$.proxy(this._onKeyDown,this),keyup:$.proxy(this._onKeyUp,this),mousedown:$.proxy(this._onFabricMouseDown,this),mousemove:$.proxy(this._onFabricMouseMove,this),mouseup:$.proxy(this._onFabricMouseUp,this)}},name:o.componentNames.CROPPER,start:function(){var t;this._cropzone||(t=this.getCanvas(),t.forEachObject(function(t){t.evented=!1}),this._cropzone=new s({left:-10,top:-10,width:1,height:1,strokeWidth:0,cornerSize:10,cornerColor:"black",fill:"transparent",hasRotatingPoint:!1,hasBorders:!1,lockScalingFlip:!0,lockRotation:!0}),t.deactivateAll(),t.add(this._cropzone),t.on("mouse:down",this._listeners.mousedown),t.selection=!1,t.defaultCursor="crosshair",fabric.util.addListener(document,"keydown",this._listeners.keydown),fabric.util.addListener(document,"keyup",this._listeners.keyup))},end:function(t){var e,n=this.getCanvas(),i=this._cropzone;return i?(i.remove(),n.selection=!0,n.defaultCursor="default",n.off("mouse:down",this._listeners.mousedown),n.forEachObject(function(t){t.evented=!0}),t&&(e=this._getCroppedImageData()),this._cropzone=null,fabric.util.removeListener(document,"keydown",this._listeners.keydown),fabric.util.removeListener(document,"keyup",this._listeners.keyup),e):null},_onFabricMouseDown:function(t){var e,n=this.getCanvas();t.target||(n.selection=!1,e=n.getPointer(t.e),this._startX=e.x,this._startY=e.y,n.on({"mouse:move":this._listeners.mousemove,"mouse:up":this._listeners.mouseup}))},_onFabricMouseMove:function(t){var e=this.getCanvas(),n=e.getPointer(t.e),i=n.x,s=n.y,o=this._cropzone;c(i-this._startX)+c(s-this._startY)>a&&(o.remove(),o.set(this._calcRectDimensionFromPoint(i,s)),e.add(o))},_calcRectDimensionFromPoint:function(t,e){var n=this.getCanvas(),i=n.getWidth(),s=n.getHeight(),o=this._startX,r=this._startY,a=h(t,0,o),c=h(e,0,r);return i=h(t,o,i)-a,s=h(e,r,s)-c,this._withShiftKey&&(i>s?s=i:s>i&&(i=s),o>=t?a=o-i:r>=e&&(c=r-s)),{left:a,top:c,width:i,height:s}},_onFabricMouseUp:function(){var t=this._cropzone,e=this._listeners,n=this.getCanvas();n.setActiveObject(t),n.off({"mouse:move":e.mousemove,"mouse:up":e.mouseup})},_getCroppedImageData:function(){var t,e=this._cropzone;return e.isValid()?(t={left:e.getLeft(),top:e.getTop(),width:e.getWidth(),height:e.getHeight()},{imageName:this.getImageName(),url:this.getCanvas().toDataURL(t)}):null},_onKeyDown:function(t){t.keyCode===u.SHIFT&&(this._withShiftKey=!0)},_onKeyUp:function(t){t.keyCode===u.SHIFT&&(this._withShiftKey=!1)}});e.exports=l},{"../consts":10,"../extension/cropzone":11,"../interface/component":17,"../util":19}],3:[function(t,e,n){"use strict";var i=t("../interface/Component"),s=t("../consts"),o=tui.util.defineClass(i,{init:function(t){this.setParent(t)},name:s.componentNames.FLIP,getCurrentSetting:function(){var t=this.getCanvasImage();return{flipX:t.flipX,flipY:t.flipY}},set:function(t){var e=this.getCurrentSetting(),n=$.Deferred(),i=e.flipX!==t.flipX,s=e.flipY!==t.flipY;return i||s?(tui.util.extend(e,t),this.setImageProperties(e,!0),this._invertAngle(i,s),this._flipObjects(i,s),n.resolve(e,this.getCanvasImage().angle)):n.reject()},_invertAngle:function(t,e){var n=this.getCanvasImage(),i=n.angle;t&&(i*=-1),e&&(i*=-1),n.setAngle(parseFloat(i)).setCoords()},_flipObjects:function(t,e){var n=this.getCanvas();t&&n.forEachObject(function(t){t.set({angle:parseFloat(-1*t.angle),flipX:!t.flipX,left:n.width-t.left}).setCoords()}),e&&n.forEachObject(function(t){t.set({angle:parseFloat(-1*t.angle),flipY:!t.flipY,top:n.height-t.top}).setCoords()}),n.renderAll()},reset:function(){return this.set({flipX:!1,flipY:!1})},flipX:function(){var t=this.getCurrentSetting();return this.set({flipX:!t.flipX,flipY:t.flipY})},flipY:function(){var t=this.getCurrentSetting();return this.set({flipX:t.flipX,flipY:!t.flipY})}});e.exports=o},{"../consts":10,"../interface/Component":15}],4:[function(t,e,n){"use strict";var i=t("../interface/Component"),s=t("../consts"),o=s.keyCodes,r=tui.util.defineClass(i,{init:function(t){this.setParent(t),this._width=12,this._oColor=new fabric.Color("rgba(0, 0, 0, 0.5)"),this._withShiftKey=!1,this._listeners={keydown:$.proxy(this._onKeyDown,this),keyup:$.proxy(this._onKeyUp,this),mousedown:$.proxy(this._onFabricMouseDown,this),mousemove:$.proxy(this._onFabricMouseMove,this),mouseup:$.proxy(this._onFabricMouseUp,this)}},name:s.componentNames.FREE_DRAWING,start:function(t){var e=this.getCanvas();e.isDrawingMode=!0,e.selection=!1,this.setBrush(t),fabric.util.addListener(document,"keydown",this._listeners.keydown),fabric.util.addListener(document,"keyup",this._listeners.keyup),e.on({"mouse:down":this._listeners.mousedown,"path:created":this._onPathCreated})},setBrush:function(t){var e=this.getCanvas().freeDrawingBrush;t=t||{},this._width=t.width||this._width,t.color&&(this._oColor=new fabric.Color(t.color)),e.width=this._width,e.color=this._oColor.toRgba()},end:function(){var t=this.getCanvas();t.isDrawingMode=!1,t.selection=!0,t.forEachObject(function(t){t.set({borderColor:"red",cornerColor:"green",transparentCorners:!1,selectable:!0,hasBorders:!0,hasControls:!0,hasRotatingPoint:!0})}),fabric.util.removeListener(document,"keydown",this._listeners.keydown),fabric.util.removeListener(document,"keyup",this._listeners.keyup),t.off("mouse:down",this._listeners.mousedown)},_onKeyDown:function(t){t.keyCode===o.SHIFT&&(this._withShiftKey=!0,this.getCanvas().isDrawingMode=!1)},_onKeyUp:function(t){t.keyCode===o.SHIFT&&(this._withShiftKey=!1,this.getCanvas().isDrawingMode=!0)},_onPathCreated:function(t){t.path.set({selectable:!1,hasBorders:!1,hasControls:!1,hasRotatingPoint:!1})},_onFabricMouseDown:function(t){var e=this.getCanvas(),n=e.getPointer(t.e),i=[n.x,n.y,n.x,n.y];this._withShiftKey&&(e.defaultCursor="crosshair",e.isDrawingMode=!1,this._line=new fabric.Line(i,{stroke:this._oColor.toRgba(),strokeWidth:this._width,originX:"center",originY:"center",selectable:!1,hasBorders:!1,hasControls:!1,hasRotatingPoint:!1}),e.add(this._line),e.on({"mouse:move":this._listeners.mousemove,"mouse:up":this._listeners.mouseup}))},_onFabricMouseMove:function(t){var e=this.getCanvas(),n=e.getPointer(t.e);this._withShiftKey&&this._line&&(this._line.set({x2:n.x,y2:n.y}),this._line.setCoords(),e.renderAll())},_onFabricMouseUp:function(){var t=this.getCanvas();this._line=null,this._withShiftKey=!1,t.defaultCursor="default",t.isDrawingMode=!0,t.off({"mouse:move":this._listeners.mousemove,"mouse:up":this._listeners.mouseup})}});e.exports=r},{"../consts":10,"../interface/Component":15}],5:[function(t,e,n){"use strict";var i=t("../interface/component"),s=t("../consts"),o={borderColor:"red",cornerColor:"green",cornerSize:10,transparentCorners:!1,scaleX:3,scaleY:3,originX:"center",originY:"center"},r={head:{width:40,height:20,left:60,top:-10,angle:90},body:{width:40,height:20,left:0,top:0}},a={leftBar:{width:10,height:50,angle:45,originX:"center",originY:"center"},rightBar:{width:10,height:50,angle:-45,originX:"center",originY:"center"}},c={arrow:"_createArrowIcon",cancel:"_createCancelIcon"},h=tui.util.defineClass(i,{init:function(t){this.setParent(t),this._oColor="#000000"},name:s.componentNames.ICON,add:function(t,e){var n=this.getCanvas(),i=this.getCanvasImage().getCenterPoint(),s=this[c[t]]();s.set(tui.util.extend(o,{angle:e||0,fill:this._oColor,left:i.x,top:i.y})),n.add(s).setActiveObject(s)},setColor:function(t){this._oColor=t},_createArrowIcon:function(){var t=new fabric.Triangle(r.head),e=new fabric.Rect(r.body);return new fabric.Group([t,e])},_createCancelIcon:function(){var t=new fabric.Rect(a.leftBar),e=new fabric.Rect(a.rightBar);return new fabric.Group([t,e])}});e.exports=h},{"../consts":10,"../interface/component":17}],6:[function(t,e,n){"use strict";var i=t("../interface/component"),s=t("../consts"),o={padding:0,crossOrigin:"anonymous"},r=tui.util.defineClass(i,{init:function(t){this.setParent(t)},name:s.componentNames.IMAGE_LOADER,load:function(t,e){var n,i,s=this;return t||e?n=this._setBackgroundImage(e).done(function(e){s.setCanvasImage(t,e),s.adjustCanvasDimension()}):(i=this.getCanvas(),i.backgroundImage=null,i.renderAll(),n=$.Deferred(function(){s.setCanvasImage("",null)}).resolve()),n},_setBackgroundImage:function(t){var e,n=$.Deferred();return t?(e=this.getCanvas(),e.setBackgroundImage(t,function(){var t=e.backgroundImage;t.getElement()?n.resolve(t):n.reject()},o),n):n.reject()}});e.exports=r},{"../consts":10,"../interface/component":17}],7:[function(t,e,n){"use strict";var i=t("../interface/component"),s=t("../consts"),o=1e3,r=800,a={cssOnly:!0},c={backstoreOnly:!0},h=tui.util.defineClass(i,{init:function(){this.canvas=null,this.canvasImage=null,this.cssMaxWidth=o,this.cssMaxHeight=r,this.imageName=""},name:s.componentNames.MAIN,toDataURL:function(t){return this.canvas&&this.canvas.toDataURL(t)},setCanvasImage:function(t,e){e&&tui.util.stamp(e),this.imageName=t,this.canvasImage=e},setCssMaxDimension:function(t){this.cssMaxWidth=t.width||this.cssMaxWidth,this.cssMaxHeight=t.height||this.cssMaxHeight},setCanvasElement:function(t){this.canvas=new fabric.Canvas($(t)[0],{containerClass:"tui-image-editor-canvas-container"})},adjustCanvasDimension:function(){var t=this.canvasImage.scale(1),e=t.getBoundingRect(),n=e.width,i=e.height,s=this._calcMaxDimension(n,i);this.setCanvasCssDimension({width:"100%",height:"100%","max-width":s.width+"px","max-height":s.height+"px"}),this.setCanvasBackstoreDimension({width:n,height:i}),this.canvas.centerObject(t)},_calcMaxDimension:function(t,e){var n=this.cssMaxWidth/t,i=this.cssMaxHeight/e,s=Math.min(t,this.cssMaxWidth),o=Math.min(e,this.cssMaxHeight);return 1>n&&i>n?(s=t*n,o=e*n):1>i&&n>i&&(s=t*i,o=e*i),{width:Math.floor(s),height:Math.floor(o)}},setCanvasCssDimension:function(t){this.canvas.setDimensions(t,a)},setCanvasBackstoreDimension:function(t){this.canvas.setDimensions(t,c)},setImageProperties:function(t,e){var n=this.canvasImage;n&&(n.set(t).setCoords(),e&&this.canvas.renderAll())},getCanvasElement:function(){return this.canvas.getElement()},getCanvas:function(){return this.canvas},getCanvasImage:function(){return this.canvasImage},getImageName:function(){return this.imageName}});e.exports=h},{"../consts":10,"../interface/component":17}],8:[function(t,e,n){"use strict";var i=t("../interface/Component"),s=t("../consts"),o=tui.util.defineClass(i,{init:function(t){this.setParent(t)},name:s.componentNames.ROTATION,getCurrentAngle:function(){return this.getCanvasImage().angle},setAngle:function(t){var e,n,i,s=this.getCurrentAngle()%360,o=$.Deferred();return t%=360,t===s?o.reject():(i=this.getCanvasImage(),e=i.getCenterPoint(),i.setAngle(t).setCoords(),this.adjustCanvasDimension(),n=i.getCenterPoint(),this._rotateForEachObject(e,n,t-s),o.resolve(t))},_rotateForEachObject:function(t,e,n){var i=this.getCanvas(),s={x:t.x-e.x,y:t.y-e.y};i.forEachObject(function(e){var i=e.getCenterPoint(),o=fabric.util.degreesToRadians(n),r=fabric.util.rotatePoint(i,t,o);e.set({left:r.x-s.x,top:r.y-s.y,angle:(e.angle+n)%360}),e.setCoords()}),i.renderAll()},rotate:function(t){var e=this.getCurrentAngle();return this.setAngle(e+t)}});e.exports=o},{"../consts":10,"../interface/Component":15}],9:[function(t,e,n){"use strict";var i=t("../interface/component"),s=t("../consts"),o={borderColor:"red",cornerColor:"green",cornerSize:10,transparentCorners:!1,fill:"#000000",left:0,top:0,padding:20,originX:"center",originY:"center"},r={fill:"#000000",fontStyle:"normal",fontWeight:"normal",textAlign:"left",textDecoraiton:""},a=tui.util.defineClass(i,{init:function(t){this.setParent(t),this._defaultStyles=o},name:s.componentNames.TEXT,add:function(t,e){var n,i=this.getCanvas(),s=this._defaultStyles;e.styles&&(s=tui.util.extend(e.styles,s)),this._setInitPos(e.position),n=new fabric.Text(t,s),i.add(n),i.getActiveObject()||i.setActiveObject(n)},change:function(t,e){t.set("text",e),this.getCanvas().renderAll()},setStyle:function(t,e){tui.util.forEach(e,function(n,i){t[i]===n&&(e[i]=r[i]||"")},this),t.set(e),this.getCanvas().renderAll()},_setInitPos:function(t){t=t||this.getCanvasImage().getCenterPoint(),this._defaultStyles.left=t.x,this._defaultStyles.top=t.y}});e.exports=a},{"../consts":10,"../interface/component":17}],10:[function(t,e,n){"use strict";var i=t("./util");e.exports={componentNames:i.keyMirror("MAIN","IMAGE_LOADER","CROPPER","FLIP","ROTATION","FREE_DRAWING","TEXT","ICON"),commandNames:i.keyMirror("CLEAR","LOAD_IMAGE","FLIP_IMAGE","ROTATE_IMAGE","ADD_OBJECT","REMOVE_OBJECT"),eventNames:{LOAD_IMAGE:"loadImage",CLEAR_OBJECTS:"clearObjects",CLEAR_IMAGE:"clearImage",START_CROPPING:"startCropping",END_CROPPING:"endCropping",FLIP_IMAGE:"flipImage",ROTATE_IMAGE:"rotateImage",ADD_OBJECT:"addObject",REMOVE_OBJECT:"removeObject",START_FREE_DRAWING:"startFreeDrawing",END_FREE_DRAWING:"endFreeDrawing",EMPTY_REDO_STACK:"emptyRedoStack",EMPTY_UNDO_STACK:"emptyUndoStack",PUSH_UNDO_STACK:"pushUndoStack",PUSH_REDO_STACK:"pushRedoStack",ACTIVATE_TEXT:"activateText"},states:i.keyMirror("NORMAL","CROP","FREE_DRAWING","TEXT"),keyCodes:{Z:90,Y:89,SHIFT:16}}},{"./util":19}],11:[function(t,e,n){"use strict";var i=t("../util").clamp,s="tl",o="tr",r="mt",a="ml",c="mr",h="mb",u="bl",l="br",f=fabric.util.createClass(fabric.Rect,{initialize:function(t){t.type="cropzone",this.callSuper("initialize",t),this.on({moving:this._onMoving,scaling:this._onScaling})},_render:function(t){var e,n,i,s,o=7,r=7;this.callSuper("_render",t),e=this.flipX?-1:1,n=this.flipY?-1:1,i=e/this.scaleX,s=n/this.scaleY,t.scale(i,s),this._fillOuterRect(t,"rgba(0, 0, 0, 0.55)"),this._strokeBorder(t,"rgb(0, 0, 0)",o),this._strokeBorder(t,"rgb(255, 255, 255)",o,r),t.scale(1/i,1/s)},_fillOuterRect:function(t,e){var n=this._getCoordinates(t),i=n.x,s=n.y;t.save(),t.fillStyle=e,t.beginPath(),t.moveTo(i[0]-1,s[0]-1),t.lineTo(i[3]+1,s[0]-1),t.lineTo(i[3]+1,s[3]+1),t.lineTo(i[0]-1,s[3]-1),t.lineTo(i[0]-1,s[0]-1),t.closePath(),t.moveTo(i[1],s[1]),t.lineTo(i[1],s[2]),t.lineTo(i[2],s[2]),t.lineTo(i[2],s[1]),t.lineTo(i[1],s[1]),t.closePath(),t.fill(),t.restore()},_getCoordinates:function(t){var e=Math.ceil,n=this.getWidth(),i=this.getHeight(),s=n/2,o=i/2,r=this.getLeft(),a=this.getTop(),c=t.canvas;return{x:tui.util.map([-(s+r),-s,s,s+(c.width-r-n)],e),y:tui.util.map([-(o+a),-o,o,o+(c.height-a-i)],e)}},_strokeBorder:function(t,e,n,i){var s=this.getWidth()/2,o=this.getHeight()/2;t.save(),t.strokeStyle=e,t.setLineDash&&t.setLineDash([n,n]),i&&(t.lineDashOffset=i),t.beginPath(),t.moveTo(-s,-o),t.lineTo(s,-o),t.lineTo(s,o),t.lineTo(-s,o),t.lineTo(-s,-o),t.stroke(),t.restore()},_onMoving:function(){var t=this.canvas,e=this.getLeft(),n=this.getTop(),s=this.getWidth(),o=this.getHeight(),r=t.getWidth()-s,a=t.getHeight()-o;this.setLeft(i(e,0,r)),this.setTop(i(n,0,a))},_onScaling:function(t){var e=this.canvas.getPointer(t.e),n=this._calcScalingSizeFromPointer(e);this.scale(1).set(n)},_calcScalingSizeFromPointer:function(t){var e=t.x,n=t.y,i=this._calcTopLeftScalingSizeFromPointer(e,n),s=this._calcBottomRightScalingSizeFromPointer(e,n);return this._makeScalingSettings(i,s)},_calcTopLeftScalingSizeFromPointer:function(t,e){var n=this.getHeight()+this.top,s=this.getWidth()+this.left,o=i(e,0,n-1),r=i(t,0,s-1);return{top:o,left:r,width:s-r,height:n-o}},_calcBottomRightScalingSizeFromPointer:function(t,e){var n=this.canvas,s=n.width,o=n.height,r=this.left,a=this.top;return{width:i(t,r+1,s)-r,height:i(e,a+1,o)-a}},_makeScalingSettings:function(t,e){var n,i=t.width,f=t.height,g=e.height,d=e.width,_=t.left,m=t.top;switch(this.__corner){case s:n=t;break;case o:n={width:d,height:f,top:m};break;case u:n={width:i,height:g,left:_};break;case l:n=e;break;case a:n={width:i,left:_};break;case r:n={height:f,top:m};break;case c:n={width:d};break;case h:n={height:g}}return n},isValid:function(){return this.left>=0&&this.top>=0&&this.width>0&&this.height>0}});e.exports=f},{"../util":19}],12:[function(t,e,n){"use strict";function i(t){return tui.util.stamp(t),new u({execute:function(e){var n=e[_].getCanvas(),i=$.Deferred();return n.contains(t)?i.reject():(n.add(t),i.resolve(t)),i},undo:function(e){var n=e[_].getCanvas(),i=$.Deferred();return n.contains(t)?(n.remove(t),i.resolve(t)):i.reject(),i}})}function s(t,e){return new u({execute:function(n){var i=n[m],s=i.getCanvas();return this.store={prevName:i.getImageName(),prevImage:i.getCanvasImage(),objects:s.getObjects().slice()},s.clear(),i.load(t,e)},undo:function(t){var e=t[m],n=e.getCanvas(),i=this.store;return n.clear(),n.add.apply(n,i.objects),e.load(i.prevName,i.prevImage)}})}function o(t){return new u({execute:function(e){var n=e[p];return this.store=n.getCurrentSetting(),n[t]()},undo:function(t){var e=t[p];return e.set(this.store)}})}function r(t,e){return new u({execute:function(n){var i=n[v];return this.store=i.getCurrentAngle(),i[t](e)},undo:function(t){var e=t[v];return e.setAngle(this.store)}})}function a(){return new u({execute:function(t){var e=t[_].getCanvas(),n=$.Deferred();return this.store=e.getObjects().slice(),this.store.length?(e.clear(),n.resolve()):n.reject(),n},undo:function(t){var e=t[_].getCanvas();return e.add.apply(e,this.store),$.Deferred().resolve()}})}function c(t){return new u({execute:function(e){var n=e[_].getCanvas(),i=$.Deferred(),s=t&&t.isType("group")&&!t.isEmpty();return s?(n.discardActiveGroup(),this.store=t.getObjects(),t.forEachObject(function(t){n.remove(t)}),i.resolve()):n.contains(t)?(this.store=[t],t.remove(),i.resolve()):i.reject(),i},undo:function(t){var e=t[_].getCanvas();return e.add.apply(e,this.store),$.Deferred().resolve()}})}function h(t,e){return e=Array.prototype.slice.call(arguments,1),d[t].apply(null,e)}var u=t("../interface/command"),l=t("../consts"),f=l.componentNames,g=l.commandNames,d={},_=f.MAIN,m=f.IMAGE_LOADER,p=f.FLIP,v=f.ROTATION;d[g.LOAD_IMAGE]=s,d[g.FLIP_IMAGE]=o,d[g.ROTATE_IMAGE]=r,d[g.CLEAR_OBJECTS]=a,d[g.ADD_OBJECT]=i,d[g.REMOVE_OBJECT]=c,e.exports={create:h}},{"../consts":10,"../interface/command":16}],13:[function(t,e,n){"use strict";var i=t("../util").keyMirror,s=i("UN_IMPLEMENTATION","NO_COMPONENT_NAME"),o={UN_IMPLEMENTATION:"Should implement a method: ",NO_COMPONENT_NAME:"Should set a component name"},r={UN_IMPLEMENTATION:function(t){return o.UN_IMPLEMENTATION+t},NO_COMPONENT_NAME:function(){return o.NO_COMPONENT_NAME}};e.exports={types:tui.util.extend({},s),create:function(t){var e;return t=t.toLowerCase(),e=r[t],Array.prototype.shift.apply(arguments),e.apply(null,arguments)}}},{"../util":19}],14:[function(t,e,n){"use strict";var i=t("./invoker"),s=t("./factory/command"),o=t("./consts"),r=o.eventNames,a=o.commandNames,c=o.componentNames,h=o.states,u=o.keyCodes,l=tui.util.defineClass({init:function(t,e){e=e||{},this._invoker=new i,this._canvas=null,this._state=h.NORMAL,this._setCanvas(t,e.cssMaxWidth,e.cssMaxHeight),this._attachInvokerEvents(),this._attachCanvasEvents(),this._attachDomEvents()},_attachInvokerEvents:function(){var t=r.PUSH_UNDO_STACK,e=r.PUSH_REDO_STACK,n=r.EMPTY_UNDO_STACK,i=r.EMPTY_REDO_STACK;this._invoker.on(t,$.proxy(this.fire,this,t)),this._invoker.on(e,$.proxy(this.fire,this,e)),this._invoker.on(n,$.proxy(this.fire,this,n)),this._invoker.on(i,$.proxy(this.fire,this,i))},_attachCanvasEvents:function(){this._canvas.on({"path:created":$.proxy(this._onPathCreated,this),"object:added":$.proxy(function(t){var e,n=t.target;n.isType("cropzone")||(tui.util.hasStamp(n)||(e=s.create(a.ADD_OBJECT,n),this._invoker.pushUndoStack(e),this._invoker.clearRedoStack()),this.fire(r.ADD_OBJECT,n))},this),"object:removed":$.proxy(function(t){this.fire(r.REMOVE_OBJECT,t.target)},this)})},_attachDomEvents:function(){fabric.util.addListener(document,"keydown",$.proxy(this._onKeyDown,this))},_onKeyDown:function(t){(t.ctrlKey||t.metaKey)&&t.keyCode===u.Z&&this.undo(),(t.ctrlKey||t.metaKey)&&t.keyCode===u.Y&&this.redo()},_onPathCreated:function(t){var e=t.path;e.set({rotatingPointOffset:30,borderColor:"red",transparentCorners:!1,cornerColor:"green",cornerSize:10})},_setCanvas:function(t,e,n){var i;i=this._getMainComponent(),i.setCanvasElement(t),i.setCssMaxDimension({width:e,height:n}),this._canvas=i.getCanvas()},_getMainComponent:function(){return this._getComponent(c.MAIN)},_getComponent:function(t){return this._invoker.getComponent(t)},getCurrentState:function(){return this._state},clearObjects:function(){var t=s.create(a.CLEAR_OBJECTS),e=$.proxy(this.fire,this,r.CLEAR_OBJECTS);t.setExecuteCallback(e),this.execute(t)},endAll:function(){this.endTextMode(),this.endFreeDrawing(),this.endCropping(),this.deactivateAll(),this._state=h.NORMAL},deactivateAll:function(){this._canvas.deactivateAll(),this._canvas.renderAll()},execute:function(t){this.endAll(),this._invoker.invoke(t)},undo:function(){this.endAll(),this._invoker.undo()},redo:function(){this.endAll(),this._invoker.redo()},loadImageFromFile:function(t,e){t&&this.loadImageFromURL(URL.createObjectURL(t),e||t.name)},loadImageFromURL:function(t,e){var n,i,o=this;e&&t&&(n=$.proxy(this._callbackAfterImageLoading,this),i=s.create(a.LOAD_IMAGE,e,t),i.setExecuteCallback(n).setUndoCallback(function(t){t?n(t):o.fire(r.CLEAR_IMAGE)}),this.execute(i))},_callbackAfterImageLoading:function(t){var e=this._getMainComponent(),n=$(e.getCanvasElement());this.fire(r.LOAD_IMAGE,{originalWidth:t.width,originalHeight:t.height,currentWidth:n.width(),currentHeight:n.height()})},startCropping:function(){var t;this.getCurrentState()!==h.CROP&&(this.endAll(),this._state=h.CROP,t=this._getComponent(c.CROPPER),t.start(),this.fire(r.START_CROPPING))},endCropping:function(t){var e,n;this.getCurrentState()===h.CROP&&(e=this._getComponent(c.CROPPER),this._state=h.NORMAL,n=e.end(t),this.fire(r.END_CROPPING),n&&this.loadImageFromURL(n.url,n.imageName))},_flip:function(t){var e=$.proxy(this.fire,this,r.FLIP_IMAGE),n=s.create(a.FLIP_IMAGE,t);n.setExecuteCallback(e).setUndoCallback(e),this.execute(n)},flipX:function(){this._flip("flipX")},flipY:function(){this._flip("flipY")},resetFlip:function(){this._flip("reset")},_rotate:function(t,e){var n=$.proxy(this.fire,this,r.ROTATE_IMAGE),i=s.create(a.ROTATE_IMAGE,t,e);i.setExecuteCallback(n).setUndoCallback(n),this.execute(i)},rotate:function(t){this._rotate("rotate",t)},setAngle:function(t){this._rotate("setAngle",t)},startFreeDrawing:function(t){this.getCurrentState()!==h.FREE_DRAWING&&(this.endAll(),this._getComponent(c.FREE_DRAWING).start(t),this._state=h.FREE_DRAWING,this.fire(r.START_FREE_DRAWING))},setBrush:function(t){this._getComponent(c.FREE_DRAWING).setBrush(t)},endFreeDrawing:function(){this.getCurrentState()===h.FREE_DRAWING&&(this._getComponent(c.FREE_DRAWING).end(),this._state=h.NORMAL,this.fire(r.END_FREE_DRAWING))},startTextMode:function(){this.endAll(),this.getCurrentState()!==h.TEXT&&(this._state=h.TEXT,this._listener=$.proxy(this._onFabricMouseDown,this),this._canvas.selection=!1,this._canvas.defaultCursor="text",this._canvas.on("mouse:down",this._listener))},addText:function(t,e){this.getCurrentState()!==h.TEXT&&(this._state=h.TEXT),this._getComponent(c.TEXT).add(t||"",e||{})},changeText:function(t){var e=this._canvas.getActiveObject();this.getCurrentState()===h.TEXT&&e&&this._getComponent(c.TEXT).change(e,t)},changeTextStyle:function(t){var e=this._canvas.getActiveObject();this.getCurrentState()===h.TEXT&&e&&this._getComponent(c.TEXT).setStyle(e,t)},endTextMode:function(){this.getCurrentState()===h.TEXT&&(this._state=h.NORMAL),this._canvas.forEachObject(function(t){t.isType("text")&&""===t.text&&t.remove()}),this._canvas.selection=!0,this._canvas.defaultCursor="default",this._canvas.off("mouse:down",this._listener)},_onFabricMouseDown:function(t){var e=t.target,n=t.e,i=this._canvas.getPointer(n);e&&!e.isType("text")||this.fire(r.ACTIVATE_TEXT,{isNew:!e,text:e?e.text:"",styles:e?{fill:e.fill,fontFamily:e.fontFamily,fontSize:e.fontSize,fontStyle:e.fontStyle,textAlign:e.textAlign,textDecoration:e.textDecoration}:{},originPosition:{x:i.x,y:i.y},clientPosition:{x:n.clientX,y:n.clientY}})},addIcon:function(t,e){this._getComponent(c.ICON).add(t,e)},changeIconColor:function(t){this._getComponent(c.ICON).setColor(t)},removeActiveObject:function(){var t=this._canvas,e=t.getActiveObject()||t.getActiveGroup(),n=s.create(a.REMOVE_OBJECT,e);this.execute(n)},toDataURL:function(t){return this._getMainComponent().toDataURL(t)},getImageName:function(){return this._getMainComponent().getImageName()},clearUndoStack:function(){this._invoker.clearUndoStack()},clearRedoStack:function(){this._invoker.clearRedoStack()}});tui.util.CustomEvents.mixin(l),e.exports=l},{"./consts":10,"./factory/command":12,"./invoker":18}],15:[function(t,e,n){"use strict";var i=tui.util.defineClass({init:function(){},setCanvasImage:function(t,e){this.getRoot().setCanvasImage(t,e)},getCanvasElement:function(){return this.getRoot().getCanvasElement()},getCanvas:function(){return this.getRoot().getCanvas()},getCanvasImage:function(){return this.getRoot().getCanvasImage()},getImageName:function(){return this.getRoot().getImageName()},getEditor:function(){return this.getRoot().getEditor()},getName:function(){return this.name},setImageProperties:function(t,e){this.getRoot().setImageProperties(t,e)},setCanvasCssDimension:function(t){this.getRoot().setCanvasCssDimension(t)},setCanvasBackstoreDimension:function(t){this.getRoot().setCanvasBackstoreDimension(t)},setParent:function(t){this._parent=t||null},adjustCanvasDimension:function(){this.getRoot().adjustCanvasDimension()},getParent:function(){return this._parent},getRoot:function(){for(var t=this.getParent(),e=this;t;)e=t,t=e.getParent();return e}});e.exports=i},{}],16:[function(t,e,n){"use strict";var i=t("../factory/errorMessage"),s=i.create,o=i.types,r=tui.util.defineClass({init:function(t){this.execute=t.execute,this.undo=t.undo,this.executeCallback=null,this.undoCallback=null},execute:function(){throw new Error(s(o.UN_IMPLEMENTATION,"execute"))},undo:function(){throw new Error(s(o.UN_IMPLEMENTATION,"undo"))},setExecuteCallback:function(t){return this.executeCallback=t,this},setUndoCallback:function(t){return this.undoCallback=t,this}});e.exports=r},{"../factory/errorMessage":13}],17:[function(t,e,n){arguments[4][15][0].apply(n,arguments)},{dup:15}],18:[function(t,e,n){"use strict";var i=t("./component/imageLoader"),s=t("./component/cropper"),o=t("./component/main"),r=t("./component/flip"),a=t("./component/rotation"),c=t("./component/freeDrawing"),h=t("./component/text"),u=t("./component/icon"),l=t("./consts").eventNames,f=tui.util.defineClass({init:function(){this._customEvents=new tui.util.CustomEvents,this._undoStack=[],this._redoStack=[],this._componentMap={},this._isLocked=!1,this._createComponents()},_createComponents:function(){var t=new o;this._register(t),this._register(new i(t)),this._register(new s(t)),this._register(new r(t)),this._register(new a(t)),this._register(new c(t)),this._register(new h(t)),this._register(new u(t))},_register:function(t){this._componentMap[t.getName()]=t},_invokeExecution:function(t){var e=this;return this.lock(),$.when(t.execute(this._componentMap)).done(function(){e.pushUndoStack(t)}).done(t.executeCallback).always(function(){e.unlock()})},_invokeUndo:function(t){var e=this;return this.lock(),$.when(t.undo(this._componentMap)).done(function(){e.pushRedoStack(t)}).done(t.undoCallback).always(function(){e.unlock()})},_fire:function(){var t=this._customEvents;t.fire.apply(t,arguments)},on:function(){var t=this._customEvents;t.on.apply(t,arguments)},getComponent:function(t){return this._componentMap[t]},lock:function(){this._isLocked=!0},unlock:function(){this._isLocked=!1},invoke:function(t){return this._isLocked?$.Deferred.reject():this._invokeExecution(t).done($.proxy(this.clearRedoStack,this))},undo:function(){var t,e=this._undoStack.pop();return e&&this._isLocked&&(this.pushUndoStack(e,!0),e=null),e?(this.isEmptyUndoStack()&&this._fire(l.EMPTY_UNDO_STACK),t=this._invokeUndo(e)):t=$.Deferred().reject(),t},redo:function(){var t,e=this._redoStack.pop();return e&&this._isLocked&&(this.pushRedoStack(e,!0),e=null),e?(this.isEmptyRedoStack()&&this._fire(l.EMPTY_REDO_STACK),t=this._invokeExecution(e)):t=$.Deferred().reject(),t},pushUndoStack:function(t,e){this._undoStack.push(t),e||this._fire(l.PUSH_UNDO_STACK)},pushRedoStack:function(t,e){this._redoStack.push(t),e||this._fire(l.PUSH_REDO_STACK)},isEmptyRedoStack:function(){return 0===this._redoStack.length},isEmptyUndoStack:function(){return 0===this._undoStack.length},clearUndoStack:function(){this.isEmptyUndoStack()||(this._undoStack=[],this._fire(l.EMPTY_UNDO_STACK))},clearRedoStack:function(){this.isEmptyRedoStack()||(this._redoStack=[],this._fire(l.EMPTY_REDO_STACK))}});e.exports=f},{"./component/cropper":2,"./component/flip":3,"./component/freeDrawing":4,"./component/icon":5,"./component/imageLoader":6,"./component/main":7,"./component/rotation":8,"./component/text":9,"./consts":10}],19:[function(t,e,n){"use strict";var i=Math.min,s=Math.max;e.exports={clamp:function(t,e,n){var o;return e>n&&(o=e,e=n,n=o),s(e,i(t,n))},keyMirror:function(){var t={};return tui.util.forEach(arguments,function(e){t[e]=e}),t}}},{}]},{},[1]);